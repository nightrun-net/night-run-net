<!DOCTYPE html>
<html lang="ku">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù„ÛŒØ³ØªØ§ ÙˆÛŒÙ„Ø§Ù†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            direction: rtl;
            text-align: right;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 700px;
            background: white;
            padding: 20px;
            margin: auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        h2 {
            text-align: center;
            color: #2c3e50;
        }
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 93%;
            padding: 10px;
            padding-right: 35px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        .icon {
            position: absolute;
            right: 10px;
            top: 40px;
            color: gray;
        }
        .btn-save, .btn-back {
            width: 100%;
            padding: 10px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        .btn-save i, .btn-back i {
            margin-left: 10px;
        }
        .btn-save:hover, .btn-back:hover {
            background: #34495e;
        }
        /* Search Bar */
        .search-container {
            margin-top: 20px;
            text-align: center;
        }
        .search-container input {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }
        /* Grid Container */
        .grid-container {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-height: 900px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            text-align: center;
        }
        .grid-item {
            background: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: right;
            font-size: 20px;
            line-height: 1.5;
        }
        /* Updated buttons style */
        .grid-item button {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            margin-left: 8px;
            padding: 6px 8px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            color: white;
        }
        .grid-item button.edit-btn {
            color: #4caf50; /* green */
        }
        .grid-item button.edit-btn:hover {
            background-color: #4caf5077;
        }
        .grid-item button.delete-btn {
            color: #e74c3c; /* red */
        }
        .grid-item button.delete-btn:hover {
            background-color: #e74c3c77;
        }
        /* Totals section */
        .totals {
            margin-top: 15px;
            background: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
        }
        .totals span {
            display: inline-block;
            min-width: 150px;
        }
        .styled-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.styled-table th, .styled-table td {
  padding: 12px 15px;
  border: 1px solid #ddd;
  text-align: center;
}

.styled-table th {
  background-color: #f4f4f4;
  font-weight: bold;
}

.styled-table tr:nth-child(even) {
  background-color: #f9f9f9;
}

.edit-btn{
  background-color: #4CAF50;
  color: white;
  padding: 5px 8px;
  margin: 0 2px;
  font-size: 14px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.delete-btn {
  background-color: #f44336;
  color: white;
  padding: 5px 8px;
  margin: 0 2px;
  font-size: 14px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.highlight-added {
  background-color: #d4edda !important; /* green */
}
.highlight-updated {
  background-color: #cce5ff !important; /* blue */
}

    </style>
</head>
<body>
        <!-- Totals displayed here -->
        <div class="totals" id="totalsSection" style="display:none;">
            <span>Ø¨Ù‡Ø§ÛŒÛ Ú©Ø±ÛŒÙ†Ø§ ÙˆÛŒÙ„Ø§Ù† : $ <span id="totalBuy">0</span></span>
            <span>Ø¨Ù‡Ø§ÛŒÛ ÙØ±ÙˆØªÙ†Ø§ ÙˆÛŒÙ„Ø§Ù† : $ <span id="totalSell">0</span></span>
        </div>

        <br><br><br>
        <div id="highlightNotes" style="margin: 1em 0; font-family: Arial, sans-serif; text-align: center;" >
            <p><span style="display:inline-block; width: 20px; height: 20px; background-color: #d4edda; border: 1px solid #c3e6cb; margin-right: 8px; vertical-align: middle;"></span>Ø¯Û•Ù…Û Ø²ÛØ¯Û•Ú©Ø±Ù†Û ( Ù£Ù  Ø®ÙˆÙ„Û•Ú© Ùˆ Ø¯Ù‡ÛØªÛ• Ø±Ø§Ú©Ø±Ù† Ø±Û•Ù†Ú¯)  </p>
            <p><span style="display:inline-block; width: 20px; height: 20px; background-color: #cce5ff; border: 1px solid #b8daff; margin-right: 8px; vertical-align: middle;"></span> Ø¯Û•Ù…Û Ù†ÛŒÚ©Ø±Ù†Û ( Ù£Ù  Ø®ÙˆÙ„Û•Ú© Ùˆ Ø¯Ù‡ÛØªÛ• Ø±Ø§Ú©Ø±Ù† Ø±Û•Ù†Ú¯)  </p>
        </div>
        
        <br><br><br>

    <div class="container">
        <h2>Ù„ÛŒØ³ØªØ§ ÙˆÛŒÙ„Ø§Ù†</h2>

        <div class="form-group">
            <label for="wheelCode"> Ú©ÙˆØ¯Û ÙˆÛŒÙ„ÛŒ :</label>
            <input type="text" id="wheelCode"/>
            <i class="fas fa-car icon"></i>
        </div>

        <div class="form-group">
            <label for="wheelColor">Ø±Û•Ù†Ú¯Û ÙˆÛŒÙ„ÛŒ :</label>
            <input type="text" id="wheelColor"/>
            <i class="fas fa-palette icon"></i>
        </div>

        <div class="form-group">
            <label for="wheelSize">Ù‚Û•Ø¨Ø§Ø±Û ÙˆÛŒÙ„ÛŒ :</label>
            <input type="text" id="wheelSize"/>
            <i class="fas fa-circle-notch icon"></i>
        </div>

        <div class="form-group">
            <label for="buyAmount">Ø¨Ù‡Ø§ÛŒÛ Ú©Ø±ÛŒÙ†Û :</label>
            <input type="number" id="buyAmount" />
            <i class="fas fa-dollar-sign icon"></i>
        </div>

        <div class="form-group">
            <label for="sellAmount">Ø¨Ù‡Ø§ÛŒÛ ÙØ±ÙˆØªÙ†Û :</label>
            <input type="number" id="sellAmount"  />
            <i class="fas fa-tag icon"></i>
        </div>

        <div class="form-group">
            <label for="quantity"> Ú˜Ù…Ø§Ø±Û•:</label>
            <input type="number" id="quantity"  />
            <i class="fas fa-boxes icon"></i>
        </div>

        <button class="btn-save" onclick="saveWheel()">
            <i class="fas fa-save"></i> ØªÙˆÙ…Ø§Ø±Ú©Ø§Ù†
        </button>

        <button class="btn-back" onclick="goBack()">
            <i class="fas fa-arrow-right"></i>  Ø²ÙØ±ÛŒÙ† Ø¨Ùˆ Ù„ÛŒØ³ØªØ§ Ø³Û•Ø±Û•Ú©ÛŒ 
        </button>
    </div>

    <div class="search-container">
        <label> Ù„ÛÚ¯Û•Ø±ÛŒØ§Ù† :</label>
        <input
          type="text"
          id="searchInput"
          placeholder=" Ú©ÙˆØ¯Û ÙˆÛŒÙ„ÛŒ, Ø±Û•Ù†Ú¯, ÛŒØ§Ù† Ù‚Û•Ø¨Ø§Ø±Û•ÛŒ Ø¨Ù†Ú¤ÛŒØ³Û•"
          onkeyup="searchWheels()"
        />
    </div>

    <table id="wheelTable" class="styled-table">
        <thead>
          <tr>
            <th>ğŸ”¢ Ú©ÙˆØ¯Û ÙˆÛŒÙ„</th>
            <th>ğŸ¨ Ø±Û•Ù†Ú¯</th>
            <th>ğŸ“ Ù‚Û•Ø¨Ø§Ø±Û•</th>
            <th>ğŸ’° Ø¨Ù‡Ø§ÛŒÛ• Ú©Ø±ÛŒÙ†Û</th>
            <th>ğŸ’µ Ø¨Ù‡Ø§ÛŒÛ• ÙØ±ÙˆØªÙ†Û</th>
            <th>ğŸ“¦ Ú˜Ù…Ø§Ø±Û•</th>
            <th>ğŸ•˜ Ø¯Û•Ù…Û Ø²ÛØ¯Û•Ú©Ø±Ù†Û</th>
            <th>â³ Ø¯Û•Ù…Û Ù†ÛŒÚ©Ø±Ù†Û</th>
            <th>âš™ï¸ Ú©Ø§Ø±</th>
          </tr>
        </thead>
        <tbody id="wheelList">
          <!-- Wheel rows will be inserted here by JS -->
        </tbody>
    </table>
      
    <script>
        // Firebase Config (update with your keys)
        const firebaseConfig = {
            apiKey: "AIzaSyBq2NdZ1UznuMuNNr37KJDKrtrM8HTMOvo",
            authDomain: "edirsbarwari-7723e.firebaseapp.com",
            databaseURL: "https://edirsbarwari-7723e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "edirsbarwari-7723e",
            storageBucket: "edirsbarwari-7723e.firebasestorage.app",
            messagingSenderId: "1098821018295",
            appId: "1:1098821018295:web:06b1d698b6d0b43b226332",
            measurementId: "G-818MFB3X5H"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let wheelsData = [];
        function saveWheel() {
  const code = document.getElementById("wheelCode").value.trim();
  const color = document.getElementById("wheelColor").value.trim();
  const size = document.getElementById("wheelSize").value.trim();
  const buy = document.getElementById("buyAmount").value.trim();
  const sell = document.getElementById("sellAmount").value.trim();
  const quantity = document.getElementById("quantity").value.trim();

  if (code && color && size && buy && sell && quantity) {
    const now = Date.now();
    const highlightUntil = now + 30 * 60 * 1000; // 30 minutes from now

    db.ref("wheels").push({
      code,
      color,
      size,
      buy: parseFloat(buy),
      sell: parseFloat(sell),
      quantity: parseInt(quantity),
      createdAt: now,
      updatedAt: now,
      highlightUntil,
      highlightType: "added"
    }).then(() => {
      alert("ÙˆÛŒÙ„ Ø¨ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ§Ù†Û• Ù‡Ø§ØªÛ• Ø²ÛØ¯Û•Ú©Ø±Ù†!");
      clearInputs();
      loadWheels();
    }).catch(error => console.error("Error:", error));
  } else {
    alert("Ù¾ÛØ¯ÙÛŒÛ• Ù‡Û•Ù…ÛŒ Ø®Ø§Ù†Û•ÛŒØ§Ù† ØªÚ˜ÛŒ Ø¨Ú©Û•ÛŒ!");
  }
}

        function clearInputs() {
            document.getElementById("wheelCode").value = "";
            document.getElementById("wheelColor").value = "";
            document.getElementById("wheelSize").value = "";
            document.getElementById("buyAmount").value = "";
            document.getElementById("sellAmount").value = "";
            document.getElementById("quantity").value = "";
        }

        function loadWheels() {
  const wheelList = document.getElementById("wheelList");
  if (!wheelList) return;

  wheelList.innerHTML = "";
  wheelsData = [];

  let totalBuy = 0;
  let totalSell = 0;

  const now = Date.now();

  db.ref("wheels").on("value", snapshot => {
    wheelList.innerHTML = "";
    wheelsData = [];

    totalBuy = 0;
    totalSell = 0;

    let wheelsArray = [];

    snapshot.forEach(childSnapshot => {
      const key = childSnapshot.key;
      const data = childSnapshot.val();

      // Cleanup expired highlights
      if (data.highlightUntil && now > data.highlightUntil) {
        db.ref("wheels/" + key).update({
          highlightUntil: null,
          highlightType: null
        });
        data.highlightUntil = null;
        data.highlightType = null;
      }

      wheelsArray.push({ key, ...data });
    });

    wheelsArray.sort((a, b) => {
      const aSize = parseInt(a.size) || 0;
      const bSize = parseInt(b.size) || 0;
      return aSize - bSize;
    });

    wheelsArray.forEach(wheel => {
      wheelsData.push(wheel);

      totalBuy += (parseFloat(wheel.buy) || 0) * (parseInt(wheel.quantity) || 0);
      totalSell += (parseFloat(wheel.sell) || 0) * (parseInt(wheel.quantity) || 0);

      createWheelItem(wheel.key, wheel, wheelList);
    });

    if (wheelsData.length > 0) {
      const totalsSection = document.getElementById("totalsSection");
      if (totalsSection) totalsSection.style.display = "flex";

      const totalBuyElem = document.getElementById("totalBuy");
      if (totalBuyElem) totalBuyElem.innerText = totalBuy.toLocaleString();

      const totalSellElem = document.getElementById("totalSell");
      if (totalSellElem) totalSellElem.innerText = totalSell.toLocaleString();

      db.ref("totals/wheels").set({
        totalBuy: totalBuy,
        totalSell: totalSell
      });
    } else {
      const totalsSection = document.getElementById("totalsSection");
      if (totalsSection) totalsSection.style.display = "none";

      db.ref("totals/wheels").set({
        totalBuy: 0,
        totalSell: 0
      });
    }
  });
}

function createWheelItem(key, data, container) {
  const row = document.createElement("tr");
  row.id = `wheel-${key}`;

  const createdDate = data.createdAt ? new Date(data.createdAt).toLocaleString() : "-";
  const updatedDate = data.updatedAt ? new Date(data.updatedAt).toLocaleString() : "-";

  row.innerHTML = `
    <td id="code-${key}">${data.code || '-'}</td>
    <td id="color-${key}">${data.color || '-'}</td>
    <td id="size-${key}">${data.size || '-'}</td>
    <td id="buy-${key}">${parseFloat(data.buy || 0).toLocaleString()}</td>
    <td id="sell-${key}">${parseFloat(data.sell || 0).toLocaleString()}</td>
    <td id="quantity-${key}">${parseInt(data.quantity || 0)}</td>
    <td>${createdDate}</td>
    <td>${updatedDate}</td>
    <td>
      <button class="edit-btn" id="editBtn-${key}">âœï¸</button>
      <button class="delete-btn" id="deleteBtn-${key}">ğŸ—‘</button>
    </td>
  `;

  container.appendChild(row);

  // Add highlight if within 30 minutes
  const now = Date.now();
  if (data.highlightUntil && now < data.highlightUntil) {
    if (data.highlightType === "added") {
      row.classList.add("highlight-added");
    } else if (data.highlightType === "updated") {
      row.classList.add("highlight-updated");
    }
  }

  document.getElementById(`editBtn-${key}`).onclick = () => editWheel(key);
  document.getElementById(`deleteBtn-${key}`).onclick = () => deleteWheel(key);
}



function editWheel(key) {
    const wheel = wheelsData.find(w => w.key === key);
    if (!wheel) return;

    // Replace text with input fields
    document.getElementById(`code-${key}`).innerHTML = `<input type="text" id="editCode-${key}" value="${wheel.code}" />`;
    document.getElementById(`color-${key}`).innerHTML = `<input type="text" id="editColor-${key}" value="${wheel.color}" />`;
    document.getElementById(`size-${key}`).innerHTML = `<input type="text" id="editSize-${key}" value="${wheel.size}" />`;
    document.getElementById(`buy-${key}`).innerHTML = `<input type="number" id="editBuy-${key}" value="${wheel.buy}" />`;
    document.getElementById(`sell-${key}`).innerHTML = `<input type="number" id="editSell-${key}" value="${wheel.sell}" />`;
    document.getElementById(`quantity-${key}`).innerHTML = `<input type="number" id="editQuantity-${key}" value="${wheel.quantity}" />`;

    // Change only this item's buttons
    const itemContainer = document.getElementById(`wheel-${key}`);
    const editBtn = itemContainer.querySelector(".edit-btn");
    const deleteBtn = itemContainer.querySelector(".delete-btn");

    editBtn.innerHTML = '<i class="fas fa-save"></i>';
    editBtn.onclick = () => saveEditWheel(key);

    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
    deleteBtn.onclick = () => loadWheels();
}

function saveEditWheel(key) {
  const code = document.getElementById(`editCode-${key}`).value.trim();
  const color = document.getElementById(`editColor-${key}`).value.trim();
  const size = document.getElementById(`editSize-${key}`).value.trim();
  const buy = document.getElementById(`editBuy-${key}`).value.trim();
  const sell = document.getElementById(`editSell-${key}`).value.trim();
  const quantity = document.getElementById(`editQuantity-${key}`).value.trim();

  if (code && color && size && buy && sell && quantity) {
    const now = Date.now();
    const highlightUntil = now + 30 * 60 * 1000; // 30 minutes from now

    db.ref("wheels").child(key).update({
      code,
      color,
      size,
      buy: parseFloat(buy),
      sell: parseFloat(sell),
      quantity: parseInt(quantity),
      updatedAt: now,
      highlightUntil,
      highlightType: "updated"
    }).then(() => {
      alert("ÙˆÛŒÙ„ Ø¨ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ§Ù†Û• Ù‡Ø§ØªÛ• Ù†ÛŒÚ©Ø±Ù†!");
      loadWheels();
    }).catch(error => console.error("Error:", error));
  } else {
    alert("Ù¾ÛØ¯ÙÛŒÛ• Ù‡Û•Ù…ÛŒ Ø®Ø§Ù†Û•ÛŒØ§Ù† ØªÚ˜ÛŒ Ø¨Ú©Û•ÛŒ!");
  }
}

        function deleteWheel(key) {
    if (confirm("ØªÛ• Ø¯ÙÛØª ÙˆÛŒÙ„ Ø¨Ù‡ÛØªÛ• Ú˜ÛØ¨Ø±Ù†ØŸ")) {
        const wheelRef = db.ref("wheels").child(key);
        const totalsRef = db.ref("totals/wheels");

        wheelRef.once("value").then(snapshot => {
            const wheel = snapshot.val();
            if (!wheel) {
                alert("ÙˆÛŒÙ„ Ù†Û• Ù‡Ø§ØªÛ• Ø¯ÛŒØªÙ†");
                throw new Error("Wheel not found");
            }

            const buyPrice = Number(wheel.buyPrice) || 0;
            const sellPrice = Number(wheel.sellPrice) || 0;

            console.log("Deleting wheel with:", { buyPrice, sellPrice });

            return totalsRef.transaction(current => {
                if (current === null) {
                    // totals/wheels doesn't exist
                    return null; // abort transaction
                }

                current.totalBuy = (current.totalBuy || 0) - buyPrice;
                current.totalSell = (current.totalSell || 0) - sellPrice;

                // Optional: Ensure they donâ€™t go negative
                if (current.totalBuy < 0) current.totalBuy = 0;
                if (current.totalSell < 0) current.totalSell = 0;

                return current;
            }).then(result => {
                if (!result.committed) {
                    throw new Error("Transaction failed or totals/wheels does not exist.");
                }
                // After updating totals, delete the wheel
                return wheelRef.remove();
            });
        }).then(() => {
            alert(" ÙˆÛŒÙ„ Ø¨ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ§Ù†Û• Ù‡Ø§ØªÛ• Ú˜ÛØ¨Ø±Ù†");
            loadWheels();
        }).catch(error => {
            console.error("Error deleting wheel:", error);
            alert("Ø¦Ø§Ø±ÛŒØ´Û•Ú© Ø¯Ø±Ø³Øª Ø¨Ùˆ Ù„Ø¯Û•Ù…Û Ú˜ÛØ¨Ø±Ù†Û");
        });
    }
    }

        function goBack() {
            window.history.back();
        }

        function searchWheels() {
            const searchValue = document.getElementById("searchInput").value.trim().toLowerCase();
            const wheelList = document.getElementById("wheelList");
            wheelList.innerHTML = "";

            if (!searchValue) {
                wheelsData.forEach(wheel => createWheelItem(wheel.key, wheel, wheelList));
                return;
            }

            const filtered = wheelsData.filter(wheel =>
                wheel.code.toLowerCase().includes(searchValue) ||
                wheel.color.toLowerCase().includes(searchValue) ||
                wheel.size.toLowerCase().includes(searchValue)
            );

            filtered.forEach(wheel => createWheelItem(wheel.key, wheel, wheelList));
        }

        window.onload = function() {
            loadWheels();
        };
    </script>
    <script>
        function showNetworkWarning(isOffline) {
            const warningId = "network-warning";
        
            if (isOffline) {
                // Show warning message if not already shown
                if (!document.getElementById(warningId)) {
                    const warning = document.createElement("div");
                    warning.id = warningId;
                    warning.innerText = "ğŸ“¡ Ø¦Û•Ù†ØªØ±Ù†ÛØª Ù‡Ø§ØªÛ• Ú˜ Ø¯Û•Ø³Øª Ø¯Ø§Ù†ØŒ Ù‡ÛŒÚ† Ù¾ÛØ²Ø§Ù†ÛŒÙ† ØªÙˆÙ…Ø§Ø±Ù†Ø§Ø¨Ù† ! ÛŒØ§ Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¦Û•Ù†ØªØ±Ù†ÛØª Ù‡Û•Ø¨ÛŒØª Ø¨Ùˆ Ú©Ø§Ø±Ú©Ø±Ù†Û !.";
                    warning.style.position = "fixed";
                    warning.style.top = "0";
                    warning.style.left = "0";
                    warning.style.width = "100%";
                    warning.style.backgroundColor = "#e74c3c";
                    warning.style.color = "white";
                    warning.style.textAlign = "center";
                    warning.style.padding = "12px";
                    warning.style.zIndex = "9999";
                    warning.style.fontSize = "18px";
                    warning.style.fontWeight = "bold";
                    document.body.appendChild(warning);
                }
            } else {
                // Remove the warning if it exists
                const existing = document.getElementById(warningId);
                if (existing) existing.remove();
            }
        }
        
        // Initial check on load
        showNetworkWarning(!navigator.onLine);
        
        // Listen for connection status changes
        window.addEventListener('online', () => showNetworkWarning(false));
        window.addEventListener('offline', () => showNetworkWarning(true));
        </script>
</body>
</html>

